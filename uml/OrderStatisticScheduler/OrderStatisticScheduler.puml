@startuml OrderStatisticScheduler

title 매출 통계 스케줄러 - 5분마다 자동 실행

participant "Spring Scheduler" as scheduler
participant "OrderStatisticScheduler" as controller
participant "OrderStatisticMapper" as mapper
participant "order_statistic Table" as db

note over scheduler
    매 5분마다 자동 실행
    @Scheduled(fixedRate = 300000)
end note

scheduler -> controller : generateOrderData()
activate controller

note over controller
    랜덤 매출 증가량 생성
    (5만원 이상, 100원 단위)
end note

controller -> controller : 랜덤 금액 생성\n(50,000원~149,900원)

controller -> mapper : getTodayStatisticCount()
activate mapper
mapper -> db : SELECT COUNT(*) WHERE DATE(reg_date) = CURDATE()
activate db
db --> mapper : count (0 또는 1)
deactivate db
mapper --> controller : todayCount
deactivate mapper

alt todayCount == 0 (오늘 데이터 없음)
    note over controller
        오늘 첫 매출 데이터 생성
    end note
    
    controller -> controller : OrderStatistic 객체 생성\n(dailyOrderSum, regDate, editDate)
    
    controller -> mapper : insertOrderStatistic(OrderStatistic)
    activate mapper
    mapper -> db : INSERT INTO order_statistic\n(daily_order_sum, reg_date, edit_date)
    activate db
    db --> mapper : 삽입 성공
    deactivate db
    mapper --> controller : 삽입 완료
    deactivate mapper
    
    note over controller
        새로운 일일 통계 생성 완료
        log.info("새로운 일일 통계 생성 완료")
    end note

else todayCount > 0 (오늘 데이터 존재)
    note over controller
        기존 매출 데이터에 누적
    end note
      controller -> mapper : updateTodayStatistic(orderIncrement)
    activate mapper
    mapper -> db : UPDATE order_statistic\nSET daily_order_sum = daily_order_sum + ?,\nedit_date = NOW()\nWHERE DATE(reg_date) = CURDATE()
    activate db
    db --> mapper : 업데이트 성공
    deactivate db
    mapper --> controller : 업데이트 완료
    deactivate mapper
    
    note over controller
        기존 일일 통계 업데이트 완료
        log.info("기존 일일 통계 업데이트 완료")
    end note
end

controller --> scheduler : 스케줄 작업 완료
deactivate controller

note over scheduler
    다음 5분 후 자동 재실행
end note

== 예외 처리 ==

group 예외 발생 시
    controller -> controller : try-catch로 예외 처리
    note over controller
        log.error("매출 데이터 업데이트 중 오류 발생")
        스케줄러는 계속 실행됨
    end note
end

@enduml
